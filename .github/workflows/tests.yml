name: Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  cpp-unit-tests:
    name: C++ Unit Tests
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a34c873a9717a888f58dc05571dde15c5886e1c5'

    - name: Install dependencies
      run: |
        vcpkg install gtest:x64-windows
        vcpkg install spdlog:x64-windows

    - name: Install OpenCppCoverage
      run: |
        choco install opencppcoverage -y
        echo "C:\Program Files\OpenCppCoverage" >> $env:GITHUB_PATH

    - name: Configure CMake
      run: |
        cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Run C++ Unit Tests with Coverage
      run: |
        OpenCppCoverage `
          --sources "${{ github.workspace }}\src" `
          --sources "${{ github.workspace }}\include" `
          --excluded_sources "${{ github.workspace }}\build" `
          --excluded_sources "${{ github.workspace }}\tests" `
          --excluded_sources "${{ github.workspace }}\vcpkg_installed" `
          --export_type cobertura:coverage.xml `
          --export_type html:coverage_report `
          -- build\tests\Release\TerminalDX12Tests.exe

    - name: Run ConPTY Contract Tests
      run: build\tests\Release\TerminalDX12ContractTests.exe

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.xml
        fail_ci_if_error: false
        verbose: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage report artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_report/
        retention-days: 14

  # Python visual tests require a GUI and cannot run in CI
  # They are intended for local development only
  #
  # To run Python tests locally:
  #   cd tests
  #   pip install -r requirements.txt
  #   pytest test_terminal.py -v --isolated
